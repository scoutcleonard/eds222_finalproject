---
title: "USDA National School Lunch Program Time Series Analysis"
author: "Scout Leonard"
date: "11/16/2021"
output: 
  html_document:
    toc: true
    toc_float: yes
    smooth_scroll: true
    theme: journal
    highlight: textmate
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
library(here)
library(lubridate)
library(tidyverse)
library(zoo)
library(feasts)
library(tsibble)
library(patchwork)
library(ggplot2)
library(broom)

options(scipen = 999)
```

# My Question:

My analysis seeks to explore the questions: _Are there seasonal differences in how U.S. school food programs feed students? What about long-term trends, and how did any trends change in 2020 during school closures from the Covid-19 pandemic?_

I have previous experience working in school food systems to expand access to this resource for school communities, but you need no time in cafeterias to guess that there would be seasonality in feeding kids. Students off for summer means fewer students participating in the school lunch in July and August. I was more interested in understanding seasonal differences within the school year: for example, _does the US feed more students in fall compared to winter?_

I am also interested in the impact of Covid-19 on school lunch. Across the U.S., many school nutrition programs adjusted to serving grab-and-go meals for students who rely on school for part of their daily nutrition during school closures. Understanding service gaps during this time 

## Background

The National School Lunch Program (NSLP) is an enormous food system with major implications for equity in American K-12 education systems. Every day, NSLP provides ~30 million children school lunch at free or reduced prices (1). It operates in public and nonprofit private schools and residential childcare facilities (2). 

To provide meals at free and reduced cost to students, participating school districts are reimbursed cash subsidies for every qualifying meal they serve. To qualify for subsidy, meals served by Nutrition Services operators must meet federal meal pattern policies which define meal content around qualifying food group combinations, sugar content, etc. 

Students from homes that experience food insecurity and hunger are reported to experience higher risk of decreased academic performance, more tardy and absent days, and more mental health challenges (4). American K-12 education and opportunities afforded to children are affected by poverty and income inequality (5). A robust understanding of school food systems can create data-informed decisions around USDA and state school food policy and on-the-ground management so that students do not have hunger as an additional barrier to their wellbeing adn academic achievement. 

# Data Description

The Food and Nutrition Services sector of the USDA offers [monthly and annual reports](https://www.fns.usda.gov/data-research) of national participation in the National School Lunch Program and other school meal programs subsidized by the USDA (breakfast, seamless summer, supper, and snacks). 

To answer my questions, I used the [National Level Monthly Data for the National School Lunch Program](https://www.fns.usda.gov/pd/child-nutrition-tables), which gives national-level monthly participation in USDA school nutrition programs since October 2017 (47 months). This data comes in publicly available .pdf and .xlsx formats. I downloaded the .xlsx format of the monthly data and did some tidying in Excel to make sure the .csv version would be friendly with R. This version of the data can be found in my [Github repository](https://github.com/scoutcleonard/eds222_finalproject).

```{r}
#read in the monthly lunch data 
usda_monthly <- read.csv(here("data", "usda_monthly_data_tidy.csv"))
```

Even after this manipulation in excel, there were changes to be made for easier manipulation of my monthly lunch data dataframe. Here, I give columns more descriptive names, remove odd columns that were added to the dataframe when I read in the .csv, mutate columns to exclude "%" "-" or spaces that R cannot make sense of. 

```{r}
#change first column name 
colnames(usda_monthly)[1] <- "month"

#delete the weird columns that got added between downloading the raw data to my 
#local computer and reading it to .Rmd
usda_monthly <- select(usda_monthly, -c("X", "X.1"))

#change last column name
colnames(usda_monthly)[9] <- "fiscal_year"
```

```{r}
#remove percent signs from percent_free_of_total_lunches and 
#percent_reduced_price_of_total_lunches columns
usda_monthly <- usda_monthly %>% 
 mutate(percent_free_of_total_lunches = gsub('%','', percent_free_of_total_lunches)) %>% 
  mutate(percent_reduced_price_of_total_lunches = gsub('%','',percent_reduced_price_of_total_lunches)) %>%
  mutate(month = gsub("-", " ", month))
```

Last, I make sure the class of each column is correct. All of the columns were of class `numeric` when read in, so I mutated the `month` column to `yearmon` using the `zoo` package, and everything else to numeric. 

```{r, results='hide'}
#convert month column to class datetime from class character
usda_monthly <- usda_monthly %>% 
  mutate("month" = zoo::as.yearmon(month, "%y %b")) %>% 
  mutate("covid_status" = ifelse(month > "Feb 2020", "covid", "pre-covid"))

usda_monthly <- usda_monthly %>% 
  mutate(percent_free_of_total_lunches = as.numeric(percent_free_of_total_lunches)) 


#add season component
usda_monthly <- usda_monthly %>% 
  mutate(month_2 = format(month, "%b")) %>% 
  mutate(season = ifelse(month_2 == "Dec" | month_2 == "Jan" | month_2 == "Feb", "winter",
                         ifelse(month_2 == "Mar" | month_2 == "Apr" | month_2 == "May", "spring",
                                ifelse(month_2 == "Jun" | month_2 == "Jul" | month_2 == "Aug", "summer",
                                       ifelse(month_2 == "Sep" | month_2 == "Oct" | month_2 == "Nov", "fall", NA)))))
```

Finally, to have an initial look at my data, I make simple line graphs here: 

```{r}
#total lunches served plot 
total_lunches_testplot <- ggplot(data = usda_monthly, aes(x = month, y = total_lunches_served)) +
  geom_line(color = "darkcyan") +
  theme_minimal() +
  labs(title = "NSLP Lunches Served (Monthly)",
       x = "Month",
       y = "Total Lunches Served")

ggsave(here("docs", "total_testplot.png"), 
       plot = last_plot(),
       dpi = 300,
       width = 15)

usda_monthly <- usda_monthly %>% 
  mutate(total_free_lunches = (total_lunches_served * percent_free_of_total_lunches) / 100)

monthly_free_testplot <- ggplot(data = usda_monthly, aes(x = month, y = total_free_lunches)) +
  geom_line(color = "darkcyan") +
  theme_minimal() +
  labs(title = "NSLP Free Lunches Served (Monthly)",
       x = "Month",
       y = "Total Lunches Served")

ggsave(here("docs", "free_testplot.png"),
       plot = last_plot(),
       dpi = 300,
       width = 15)
```

At a first glance, I can see that there are seasonal dips in NSLP lunch participation in the summers, as expected. There also appears to be a dip in participation before January, which I would suspect is due to holiday recesses. It seems that the start of the school year does have higher participation than any of the winter and spring months, though. 

I can see that participation dropped dramatically when schools closed, by about 2/3 for all students, and by 1/2 for just the students who qualify for free lunch. 

## Data Quality

Every school day, school cafeteria staff at participating NSLP schools report meals claimed by students who qualify for free- and reduced-priced lunches. That meets the numbers from this dataset are self-reported by schools and districts nationally. The USDA conducts periodically audits schools to control for accurate serving, counting, and claiming or reimbursable meals. 

This analysis assumes that the numbers presented by the USDA are accurate monthly meals served nationally, but there is risk for systematically biased sampling. In my own work, I have observed inaccurate claim reports as a results of short staffing and reduced bandwidth for serving _and_ counting. This may mean that school nutrition programs with lower budgets (i.e. more free-and-reduced eligible students, because of funding models) are at risk for less accurate reporting.

# Analysis Plan

## Seasonality in NSLP

For the first part of my analysis, I investigate seasonal differences in NSLP participation by decomposing the data seasonal and trend components using the `classical_decomposition()` function and applying `autoplot()` to that: 

I first create a tsibble with the months as class `yearmonth` and the total lunches served per month, then create an additive classical decomposition model. I then use this model to generate an autoplot which helps to visualize the presence of seasonality and long-term trends in the data for both groups. 

Finally, I generate an autocorrelation function with a lag of 12 because I want to see how much participation in one month is correlated with participation for the rest of the school year. 

```{r return = FALSE}
#confusingly, converting the data I want in my time series requires data of class `yearmonth` not `yearmon` I learned I can use `yearmonth()` from the tsibble package to make a tsibble with the correct time class 
usda_monthly <- usda_monthly %>% 
  mutate(month = yearmonth(month))

monthly_tsib <- usda_monthly %>%
  select(c(month, total_lunches_served)) %>% 
  as_tsibble()
```

```{r}
total_decomp = monthly_tsib %>% 
  model(
    classical_decomposition(total_lunches_served, type = "additive")
  ) %>% 
  components()

total_auto <- autoplot(total_decomp) %>% 
  labs(title = "Classical Decomposition for USDA NSLP Lunch Participation")
```

## Impact of Covid on NSLP

In addition to considering the trend component of the classical decomposition from March 2020 onward, I also complete a hypothesis test to compare the mean monthly participation in the NSLP before and during the Covid-19 pandemic.

```{r}
covid_df <- usda_monthly %>% 
  filter(covid_status == "covid")

pre_covid_df <- usda_monthly %>% 
  filter(covid_status == "pre-covid")

mean_fed_precovid <- mean(pre_covid_df$total_lunches_served)
mean_fed_covid <- mean(covid_df$total_lunches_served)
```

Mean monthly participation in the NSLP prior to Covid-19 was `r mean_fed_precovid` and mean monthly participation in the NSLP during the Covid-19 pandemic is `r mean_fed_covid`. 

My null hypothesis is that there is no significant difference between the pre- and during- Covid-19 lunches served, and my alternative hypothesis is that there is a significant different between the conditions. I test the null hypothesis using a Welch's two-sample t test. 

# Summarize results visually and in words

Ultimately, my results showed that there is only a statistically significant correlation between student participation in month 1 and students participation in months 2, 3, 11, and 12. I interpret this as demonstrating that the NSLP is feeding children differently across the school year, and that participation during the first month of the year can only tell us something about participation for 1/4 of the year. 

## Seasonality of NSLP

```{r fig.width= 6, fig.height=3}
total_acf <- acf(monthly_tsib, lag.max = 12)
```

The results of my decomposition function autoplot demonstrate a stronger seasonal effect in NSLP participation among all participating students. We can see declines in participation during the summer months, as we would expect but also changes in participation during the school year. I predict that because the data is reported as a monthly total, that there are seasonal decreases in participation during months with school breaks (in winter and spring), and so I am not sure that there is evidence enough to say that the NSLP participating schools and districts feed students differently seasonally. 

```{r fig.width= 6, fig.height=3}
total_auto
```

Any seasonal differences between school months were drowned out by the seasonal differences between school months and summer months. To further investigate the seasonal differences in meals served, I tried to also run hypothesis tests comparing total meals served for fall and spring months, fall and winter months, and spring and winter months. 

```{r}
#t test: fall versus rest of school year
tidy(t.test(usda_monthly$total_lunches_served[usda_monthly$season == "fall"], usda_monthly$total_lunches_served[usda_monthly$season != "fall" | usda_monthly$season != "summer"]))
```

```{r}
tidy(t.test(usda_monthly$total_lunches_served[usda_monthly$season == "winter"], usda_monthly$total_lunches_served[usda_monthly$season != "winter" | usda_monthly$season != "summer"]))
```

```{r}
tidy(t.test(usda_monthly$total_lunches_served[usda_monthly$season == "spring"], usda_monthly$total_lunches_served[usda_monthly$season != "spring" | usda_monthly$season != "summer"]))
```

## Impact of Covid on NSLP

```{r}
t.test(total_lunches_served ~ covid_status, data = usda_monthly)
```



# Next steps and future directions

The USDA's data platform only allows me to access NSLP participation data from 2017 onward. As a next step, I might reach out to their data services to try to obtain data from previous years. 47 months of data are not enough to satisfy the Central Limit Theorem.

# References

(1) https://www.ers.usda.gov/topics/food-nutrition-assistance/child-nutrition-programs/national-school-lunch-program/ 
(2) https://fns-prod.azureedge.net/sites/default/files/resource-files/NSLPFactSheet.pdf
(3) http://bestpractices.nokidhungry.org/sites/default/files/2020-06/Need%20for%20School%20Nutrition%20Budget%20Relief.pdf
(4) https://www.karger.com/Article/Pdf/66399